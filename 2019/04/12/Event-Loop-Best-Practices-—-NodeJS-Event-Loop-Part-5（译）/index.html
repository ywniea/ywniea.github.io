<!DOCTYPE html><html lang="en"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content=""><title>Event Loop Best Practices — NodeJS Event Loop Part 5（译） | Ywinea's blog</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/normalize/8.0.1/normalize.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//lib.baomitu.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//lib.baomitu.com/jquery/3.4.0/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"><meta name="generator" content="Hexo 4.0.0"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Event Loop Best Practices — NodeJS Event Loop Part 5（译）</h1><a id="logo" href="/.">Ywinea's blog</a><p class="description"></p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> Home</i></a><a href="/archives/"><i class="fa fa-archive"> Archive</i></a><a href="/about/"><i class="fa fa-user"> About</i></a><a href="/atom.xml"><i class="fa fa-rss"> RSS</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Event Loop Best Practices — NodeJS Event Loop Part 5（译）</h1><div class="post-meta">Apr 12, 2019<span> | </span><span class="category"><a href="/categories/JavaScript/">JavaScript</a></span></div><div class="post-content"><p>原文：<a href="https://blog.insiderattack.net/event-loop-best-practices-nodejs-event-loop-part-5-e29b2b50bfe2" target="_blank" rel="noopener">https://blog.insiderattack.net/event-loop-best-practices-nodejs-event-loop-part-5-e29b2b50bfe2</a> 作者：Deepal Jayasekara</p>
<p>这篇文章将讲述event loop最佳实践。</p>
<a id="more"></a>

<h4 id="避免在重复调用的代码块内部使用一些同步操作I-O的方法"><a href="#避免在重复调用的代码块内部使用一些同步操作I-O的方法" class="headerlink" title="避免在重复调用的代码块内部使用一些同步操作I/O的方法"></a>避免在重复调用的代码块内部使用一些同步操作I/O的方法</h4><p>请避免在一些重复调用的代码块（例如循环，或者是一些经常会被调用到的方法）中使用同步操作I/O的方法（例如<code>fs.readFileSync</code>, <code>fs.renameSync</code>等）。这会在很大程度上降低应用程序的性能，因为每次执行同步I/O操作时， event loop 会一直被阻塞，直到他们完成。最安全的使用这些同步方法的案例之一就是在程序开始的时候读取配置文件。</p>
<h4 id="方法要么完全是异步的，要么完全是同步的"><a href="#方法要么完全是异步的，要么完全是同步的" class="headerlink" title="方法要么完全是异步的，要么完全是同步的"></a>方法要么完全是异步的，要么完全是同步的</h4><p>应用程序是由函数组成的。在NodeJS中，有两种类型的方法。</p>
<ul>
<li>同步方法。大部分时候用<code>return</code>关键字返回输出（例如 Math functions, fs.readFileSync等）。或者使用连续传递风格返回（如map, filter, reduce等）。</li>
<li>异步方法。使用回调或者Promise延时返回结果。</li>
</ul>
<p>一条经验就是，你写的函数应该是</p>
<ul>
<li>完全同步：所有的输入，所有的条件，都是同步的</li>
<li>完全异步：所有的输入，所有的条件，都是异步的</li>
</ul>
<p>如果你在一个函数中混合使用同步和异步，那么你的应用的行为将会变得不可预测。来看个例子。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> cache = &#123;&#125;;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">readFile</span>(<span class="params">fileName, callback</span>) </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (cache[filename]) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">return</span> callback(<span class="literal">null</span>, cache[filename])</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">    fs.readFile(fileName, (err, fileContent) =&gt; &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">if</span> (err) <span class="keyword">return</span> callback(err);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">        </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">        cache[fileName] = fileContent;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">        callback(<span class="literal">null</span>, fileContent);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">    &#125;);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>
<p>现在用上面这个<code>readFile</code>函数写个小应用，为了方便阅读，删掉了错误处理。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">letsRead</span>(<span class="params"></span>)</span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">  readFile(<span class="string">'myfile.txt'</span>, (err, result) =&gt; &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// error handler redacted</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">    <span class="built_in">console</span>.log(<span class="string">'file read complete'</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">  &#125;);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">  <span class="built_in">console</span>.log(<span class="string">'file read initiated'</span>)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>
<p>现在运行两次这个<code>letsRead</code>，得到下面的结果</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">file read initiated</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">file read complete</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">file read complete</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">file read initiated</span></pre></td></tr></table></figure>
<p>为什么前后结果不一样？<br>第一次运行<code>letsRead</code>，<code>myfile.txt</code>文件不在cache中，因此异步函数<code>fs.readFile</code>会去文件系统读取文件。在这种情况下，callback函数会在异步读取文件完成之后的回调函数中调用，因此是callback函数的执行是异步的，会先打印出同步代码<code>file read initiated</code>。</p>
<p>当<code>letsRead</code>方法第二次运行的时候，<code>myfile.txt</code>这个文件在第一次就被缓存了，因此就不必去读取文件系统，从而执行的callback函数是同步的，会先打印出callback里面的<code>file read complete</code>。</p>
<p>当应用程序很复杂的时候，这种前后行为不一致的同步异步混合的函数会引起许多问题，并且特别难于debug和修复。因此强烈建议使用这条编写完全同步或完全异步方法的规则。</p>
<p>我们可以这样修改这个<code>readFile</code>两个方法：</p>
<ol>
<li>利用<code>fs.readFileSync</code>方法是<code>readFile</code>方法变为一个完全同步的方法。</li>
<li>通过异步调用回调函数，使 <code>readFile</code> 函数完全异步。</li>
</ol>
<p>参考第一条建议，在经常重复被调用的函数中应该调用异步函数。因此我们应该使用第二个方法。因为方法一会有严重的性能问题。我么可以使用<code>process.nextTick</code>来实现方法二。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> cache = &#123;&#125;;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">readFile</span>(<span class="params">fileName, callback</span>) </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (cache[filename]) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">return</span> process.nextTick(<span class="function"><span class="params">()</span> =&gt;</span> callback(<span class="literal">null</span>, cache[filename]));</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">    fs.readFile(fileName, (err, fileContent) =&gt; &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">if</span> (err) <span class="keyword">return</span> callback(err);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">        </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">        cache[fileName] = fileContent;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">        callback(<span class="literal">null</span>, fileContent);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">    &#125;);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>

<p><code>process.nextTick</code>会将调用callback推迟event loop的一个阶段。现在如果连续两次调用<code>letsRead</code>就会得到一致的结果了：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">file read initiated</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">file read complete</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">file read initiated</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">file read complete</span></pre></td></tr></table></figure>
<p>也可以使用 <code>setImmediate</code> 来实现这一点，但我更喜欢使用 <code>process.nextTick</code>，因为 <code>nextTick queue</code> 比<code>immediate queue</code>处理得更频繁。</p>
<h4 id="太多nextTicks"><a href="#太多nextTicks" class="headerlink" title="太多nextTicks"></a>太多nextTicks</h4><p>虽然 <code>process.nextTick</code> 在许多情况下非常有用，但递归使用 <code>process.nextTick</code> 可能导致 I/O 饥饿。 这将强制 Node 递归地执行 nextTick 回调，而不进入 I/O 阶段。</p>
<p>以前的 NodeJS 版本(≤0.10)提供了一种设置 nextTick 回调的最大深度的方法，可以使用 <code>process.maxTickDepth</code> 进行设置。 但是在 NodeJS 0.12中引入了 <code>setImmediate</code>，<code>process.maxTickDepth</code>就被抛弃了。 因此，目前没有办法限制nextTicks，从而导致I/O饥饿。</p>
<h4 id="Dns-lookup-vs-dns-resolve"><a href="#Dns-lookup-vs-dns-resolve" class="headerlink" title="Dns.lookup () vs dns.resolve * ()"></a>Dns.lookup () vs dns.resolve * ()</h4><p>如果你浏览过 node.js 的 dns 模块文档，你可能会发现有两种使用 dns 模块将主机名解析为 IP 地址的方法。 它们要么使用 <code>dns.lookup</code>，要么使用其中一个 dns 解析函数，如 <code>dns.resolve4</code>、 <code>dns.resolve6</code>等。 虽然这两种方法看起来是相同的，但它们在内部工作方式上有明显的区别。</p>
<p><code>Dns.lookup</code>函数的行为类似于 ping 命令解析主机名。它在操作系统的网络 API 中调用 <code>getaddrinfo</code> 函数。 不幸的是，这个调用不是一个异步调用。 因此，为了模拟异步行为，这个调用使用 <code>uv_getaddrinfo</code> 函数在 libuv 的线程池上运行。这可能会增加线程在线程池上运行的其他任务之间的争用，并可能对应用程序的性能造成负面影响。 修改 libuv 线程池默认只包含4个线程也很重要。 因此，四个并行的 dns.lookup 调用完全占用了线程池，导致其他请求(文件 i / o、某些加密函数、可能更多的 dns 查找)无法满足需求。</p>
<p>相比之下，dns.resolve ()和其他 dns.resolve * ()的行为则不同。 以下是官方文档中对 dns.resolve * 的描述。</p>
<blockquote>
<p>These functions are implemented quite differently than dns.lookup(). They do not use getaddrinfo(3) and they always perform a DNS query on the network. This network communication is always done asynchronously, and does not use libuv’s threadpool.</p>
<p>这个方法的实现和<code>dns.lookup</code>完全不同。它不使用<code>getaddrinfo(3)</code>函数并且它通过网络查询DNS。这个网络链接是异步的，并且不使用libuv的线程池。</p>
</blockquote>
<p>Node.js 使用一种称为 c-ares 的流行依赖关系提供 DNS 解析功能。 这个库不依赖于 libuv 的线程池，并且完全在网络上运行。</p>
<p><code>Dns.resolve</code> 不会让 libuv 线程池过载。 因此，最好使用 <code>dns.resolve</code> 而不是 <code>dns.lookup</code>，除非需要坚持使用配置文件（例如/etc/nsswitch.conf, /etc/hosts）这些配置文件会使用<code>getaddrinfo</code>。</p>
<p>但是还有一个更大的问题！<br>假设你正在使用 node.js 向 <a href="http://www.example" target="_blank" rel="noopener">www.example</a>. com 发出一个 HTTP 请求。 首先，它将把 <a href="http://www.example" target="_blank" rel="noopener">www.example</a>. com 解析为一个 IP 地址。 然后使用已解析的 IP 异步建立 TCP 连接。 因此，发送一个 HTTP 请求是一个两步的过程。</p>
<p>目前，Node http 和 https 模块内部都使用 dns.lookup 将主机名解析为 IP。多个 http 请求可以轻松地使线程池对其他请求失效。如果您注意到应用程序在文件 i / o、加密或任何其他与线程池相关的任务方面的性能大幅下降，那么您可以采取一些措施来提高应用程序的性能。</p>
<ul>
<li>通过设置<code>UV_THREADPOOL_SIZE</code> 环境变量可以将线程池的容量增加到128个线程</li>
<li>使用<code>dns.resolve*</code>将主机名解析为 IP 地址并直接使用 IP 地址。</li>
</ul>
<p>以下是一个例子。请注意，下面的脚本是未经优化的，只是一个参考。想要写的更健壮的话还有许多其他因素需要考虑。 另外，下面的代码只能用于 Node v8.0.0以后的版本，因为在早期的 tls.connect 实现中没有使用 lookup 选项。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> dns = <span class="built_in">require</span>(<span class="string">'dns'</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> https = <span class="built_in">require</span>(<span class="string">'https'</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> tls = <span class="built_in">require</span>(<span class="string">'tls'</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> net = <span class="built_in">require</span>(<span class="string">'net'</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> request = <span class="built_in">require</span>(<span class="string">'request'</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> httpAgent = <span class="keyword">new</span> http.Agent();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> httpsAgent = <span class="keyword">new</span> https.Agent();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> createConnection = <span class="function">(<span class="params">&#123; isHttps = <span class="literal">false</span> &#125; = &#123;&#125;</span>) =&gt;</span> &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">const</span> connect = isHttps ? tls.connect : net.connect;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params">args, cb</span>) </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">return</span> connect(&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">            port : args.port,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">            host : args.host,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">            lookup : <span class="function"><span class="keyword">function</span>(<span class="params">hostname, args, cb</span>) </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">                dns.resolve(hostname, <span class="function"><span class="keyword">function</span>(<span class="params">err, ips</span>) </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line">                    <span class="keyword">if</span> (err) &#123; <span class="keyword">return</span> cb(err); &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line">                    <span class="keyword">return</span> cb(<span class="literal">null</span>, ips[<span class="number">0</span>], <span class="number">4</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">22</span></pre></td><td class="code"><pre><span class="line">                &#125;);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">23</span></pre></td><td class="code"><pre><span class="line">            &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">24</span></pre></td><td class="code"><pre><span class="line">        &#125;, cb);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">25</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">26</span></pre></td><td class="code"><pre><span class="line">&#125;;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">27</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">28</span></pre></td><td class="code"><pre><span class="line">httpAgent.createConnection = createConnection();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">29</span></pre></td><td class="code"><pre><span class="line">httpsAgent.createConnection = createConnection(&#123;<span class="attr">isHttps</span>: <span class="literal">true</span>&#125;);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">30</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">31</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getRequest</span>(<span class="params">reqUrl</span>) </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">32</span></pre></td><td class="code"><pre><span class="line">    request(&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">33</span></pre></td><td class="code"><pre><span class="line">        method: <span class="string">'get'</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">34</span></pre></td><td class="code"><pre><span class="line">        url: reqUrl,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">35</span></pre></td><td class="code"><pre><span class="line">        agent: httpsAgent</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">36</span></pre></td><td class="code"><pre><span class="line">    &#125;, (err, res) =&gt; &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">37</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">if</span> (err) <span class="keyword">throw</span> err;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">38</span></pre></td><td class="code"><pre><span class="line">        <span class="built_in">console</span>.log(res.body);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">39</span></pre></td><td class="code"><pre><span class="line">    &#125;)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">40</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">41</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">42</span></pre></td><td class="code"><pre><span class="line">getRequest(<span class="string">'https://example.com'</span>);</span></pre></td></tr></table></figure>
<p>用<code>dns.resolve</code>来自定义一个http代理编写的请求模块。</p>
<h4 id="对-Threadpool-的担忧"><a href="#对-Threadpool-的担忧" class="headerlink" title="对 Threadpool 的担忧"></a>对 Threadpool 的担忧</h4><p>正如我们在整个系列中所看到的，除了文件 i / o 之外，libuv 的线程池还有许多其他用途，可能成为某些应用程序的瓶颈。 如果您认为您的应用程序在文件 i / o 或加密操作方面似乎比通常慢，那么可以考虑通过设置<code>UV_THREADPOOL_SIZE</code>环境变量来增加线程池的大小。</p>
<h4 id="事件循环监视"><a href="#事件循环监视" class="headerlink" title="事件循环监视"></a>事件循环监视</h4><p>监视事件循环中的延迟对于防止中断是至关重要的。 这也可以用于生成警报、执行强制重新启动和扩展服务。</p>
<p>识别事件循环延迟的最简单方法是检查计时器执行回调所需的额外时间。 简单来说，假设我们将计时器调度为500毫秒，如果执行计时器的回调需要550毫秒，我们可以推断事件循环延迟大约为50毫秒。这额外的50毫秒应该是在事件循环的其他阶段执行事件所花费的时间。可以使用<code>loopbench</code> 模块来完成事件循环监视。 让我们看看如何做到这一点。<br>一旦安装完毕，您就可以在应用程序中使用 <code>loopbench</code>，只需要几行简单的代码。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> LoopBench = <span class="built_in">require</span>(<span class="string">'loopbench'</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> loopBench = LoopBench();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"><span class="built_in">console</span>.log(<span class="string">`loop delay: <span class="subst">$&#123;loopBench.delay&#125;</span>`</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line"><span class="built_in">console</span>.log(<span class="string">`loop delay limit: <span class="subst">$&#123;loopBench.limit&#125;</span>`</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line"><span class="built_in">console</span>.log(<span class="string">`is loop overloaded: <span class="subst">$&#123;loopBench.overlimit&#125;</span>`</span>);</span></pre></td></tr></table></figure>
<p>可以暴露一个安全的检查点，使外部程序获取到上面这些值。<br>上面API的一个例子可能有类似下面的输出。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">  <span class="string">"message"</span>: <span class="string">"application is running"</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">  <span class="string">"data"</span>: &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">    <span class="string">"loop_delay"</span>: <span class="string">"1.2913 ms"</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">    <span class="string">"loop_delay_limit"</span>: <span class="string">"42 ms"</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">    <span class="string">"is_loop_overloaded"</span>: <span class="literal">false</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">  &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>
<p>有了这个实现，如果循环超载以防止进一步的超载，您可以用您的检查API返回503服务不可响应。这也可以帮助负载均衡器将请求路由到应用程序的其他实例。</p>
</div><div class="tags"><a href="/tags/Node-js/">Node.js</a></div><div class="post-nav"><a class="pre" href="/2019/04/15/New-Changes-to-the-Timers-and-Microtasks-in-Node-v11-0-0-and-above-%EF%BC%88%E8%AF%91%EF%BC%89/">New Changes to the Timers and Microtasks in Node v11.0.0 (and above) Part 6（译）</a><a class="next" href="/2019/04/11/Handling-IO-%E2%80%94-NodeJS-Event-Loop-Part-4-%E8%AF%91/">Handling IO — NodeJS Event Loop Part 4(译)</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="https://github.com/ywniea"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> Categories</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/CSS/">CSS</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/JavaScript/">JavaScript</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Other/">Other</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/React/">React</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%86%B0%E6%9E%9C/">冰果</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> Tags</i></div><div class="tagcloud"><a href="/tags/JavaScript/" style="font-size: 15px;">JavaScript</a> <a href="/tags/Flex/" style="font-size: 15px;">Flex</a> <a href="/tags/Other/" style="font-size: 15px;">Other</a> <a href="/tags/Node-js/" style="font-size: 15px;">Node.js</a> <a href="/tags/%E5%86%B0%E6%9E%9C/" style="font-size: 15px;">冰果</a> <a href="/tags/Grid/" style="font-size: 15px;">Grid</a> <a href="/tags/React-lifecycle/" style="font-size: 15px;">React lifecycle</a> <a href="/tags/React-memo/" style="font-size: 15px;">React memo</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> Recent</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2019/12/03/%E3%80%8C%E9%9D%9E%E5%81%9A%E4%B8%8D%E5%8F%AF%E7%9A%84%E4%BA%8B%E5%B0%B1%E5%B0%BD%E5%BF%AB%E8%A7%A3%E5%86%B3%E3%80%8D/">「非做不可的事就尽快解决」</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/05/05/Grid%E5%B8%83%E5%B1%80/">Grid布局</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/04/15/New-Changes-to-the-Timers-and-Microtasks-in-Node-v11-0-0-and-above-%EF%BC%88%E8%AF%91%EF%BC%89/">New Changes to the Timers and Microtasks in Node v11.0.0 (and above) Part 6（译）</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/04/12/Event-Loop-Best-Practices-%E2%80%94-NodeJS-Event-Loop-Part-5%EF%BC%88%E8%AF%91%EF%BC%89/">Event Loop Best Practices — NodeJS Event Loop Part 5（译）</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/04/11/Handling-IO-%E2%80%94-NodeJS-Event-Loop-Part-4-%E8%AF%91/">Handling IO — NodeJS Event Loop Part 4(译)</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/04/10/Promises-Next-Ticks-and-Immediates%E2%80%94-NodeJS-Event-Loop-Part-3-%E8%AF%91/">Promises, Next-Ticks, and Immediates— NodeJS Event Loop Part 3(译)</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/04/08/Timers-Immediates-and-Process-nextTick%E2%80%94-NodeJS-Event-Loop-Part-2-%E8%AF%91/">Timers, Immediates and Process.nextTick— NodeJS Event Loop Part 2(译)</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/04/07/Event%20Loop%20and%20the%20Big%20Picture%20%E2%80%94%20NodeJS%20Event%20Loop%20Part%201%EF%BC%88%E8%AF%91)/">Event Loop and the Big Picture — NodeJS Event Loop Part 1（译）</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/10/11/throttle-and-debounce/">throttle and debounce</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/06/15/%E7%BB%A7%E6%89%BF-vs-%E8%A1%8C%E4%B8%BA%E5%A7%94%E6%89%98/">继承 vs 行为委托</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> Links</i></div><ul></ul><a href="https://www.github.com/ywniea" title="github" target="_blank">github</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2019 <a href="/." rel="nofollow">Ywinea's blog.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>